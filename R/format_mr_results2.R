#' Split outcome column 
#'
#' This function takes the outcome column from the results generated by mr() and splits it into separate columns for 'outcome name', 'consortium' and 'year'
#'
#' @param mr_res Results from mr()
#'
#' @export
#' @return data frame
split_outcome <- function(mr_res)
{
	Pos<-grep("\\|\\|",mr_res$outcome) #the "||"" indicates that the outcome column was derived from summary data in MR-Base. Sometimes it wont look like this e.g. if the user has supplied their own outcomes
	mr_res$trait<-mr_res$outcome
	Outcome<-mr_res$outcome[Pos]
	Vars<-unlist(strsplit(Outcome,split= "\\|\\|"))
	Vars<-trim(Vars)
	Trait<-Vars[seq(1,length(Vars),by=3)]
	Consortium<-Vars[seq(2,length(Vars),by=3)]
	Year<-Vars[seq(3,length(Vars),by=3)]
	mr_res$trait[Pos]<-Trait
	mr_res$consortium<-NA
	mr_res$consortium[Pos]<-Consortium
	mr_res$year<-NA
	mr_res$year[Pos]<-Year
	return(mr_res)
}

#' Generate odds ratios 
#'
#' This function takes b and se from mr() and generates odds ratios and 95 percent confidence intervals
#'
#' @param mr_res Results from mr()
#'
#' @export
#' @return data frame		
generate_odds_ratios <- function(mr_res) 
{
	mr_res$lo_ci <- mr_res$b - 1.96 * mr_res$se
	mr_res$up_ci <- mr_res$b + 1.96 * mr_res$se
	mr_res$or <- exp(mr_res$b)
	mr_res$or_lci95 <- exp(mr_res$lo_ci)
	mr_res$or_uci95 <- exp(mr_res$up_ci)
	return(mr_res)
}

#' Subset MR-results on method
#'
#' This function takes MR results from mr() and restricts to a single method per exposure x disease combination 
#'
#' @param mr_res Results from mr()
#' @param single_snp_method Which of the single SNP methosd to use when only 1 SNP was used to estimate the causal effect? Default="Wald ratio"
#' @param multi_snp_method Which of the multi-SNP methods to use when there was more than 1 SNPs used to estimate the causal effect? Default="Inverse variance weighted"
#'
#' @export
#' @return data frame.
subset_on_method <- function(mr_res, single_snp_method="Wald ratio", multi_snp_method="Inverse variance weighted")
{
	dat <- subset(mr_res, (nsnp==1 & method==single_snp_method) | (nsnp > 1 & method == multi_snp_method))
	return(dat)

}

#' Combine all mr results
#'
#' This function combines results of mr(), mr_heterogeneity(), mr_pleiotropy() and mr_singlesnp() into a single data frame. It also merges the results with outcome study level characteristics in available_outcomes(). If desired it also exponentiates results (e.g. if the user wants log odds ratio converted into odds ratios with 95 percent confidence intervals)
#'
#' @param Res Results from mr()
#' @param Het Results from mr_heterogeneity()
#' @param Egger_intercept Results from mr_pleiotropy_test()
#' @param SingleSNPs Results from mr_singlesnp()
#' @param ao_slc Logical; if set to TRUE then outcome study level characteristics are retrieved from available_outcomes(). Default is TRUE. 
#' @param Exp Logical; if set to TRUE results are exponentiated. Useful if user wants log odds ratios expressed as odds ratios. Default is FALSE. 
#' 
#' @export
#' @return data frame
combine_all_mrresults <- function(Res,Het,Egger_intercept,SingleSNPs,ao_slc=T,Exp=F)
{
	Het<-Het[,c("id.outcome","method","Q","Q_df","Q_pval")]

	# Convert all factors to character
	# lapply(names(Res), FUN=function(x) class(Res[,x]))
	Pos<-which(unlist(lapply(names(Res), FUN=function(x) class(Res[,x])))=="factor")
	for(i in 1:length(Pos)){
		Res[,Pos[i]]<-as.character(Res[,Pos[i]])
	}

	# lapply(names(Het), FUN=function(x) class(Het[,x]))
	Pos<-which(unlist(lapply(names(Het), FUN=function(x) class(Het[,x])))=="factor")
	for(i in 1:length(Pos)){
		Het[,Pos[i]]<-as.character(Het[,Pos[i]])
	}

	# lapply(names(SingleSNPs), FUN=function(x) class(SingleSNPs[,x]))
	Pos<-which(unlist(lapply(names(SingleSNPs), FUN=function(x) class(SingleSNPs[,x])))=="factor")
	for(i in 1:length(Pos)){
		SingleSNPs[,Pos[i]]<-as.character(SingleSNPs[,Pos[i]])
	}
	SingleSNPs<-SingleSNPs[grep("[:0-9:]",SingleSNPs$SNP),]
	SingleSNPs$method<-"Wald ratio"
	names(SingleSNPs)[names(SingleSNPs)=="p"]<-"pval"

	# Res<-Res[Res$method %in% c("MR Egger","Weighted median","Inverse variance weighted"),]

	#method is also the name of an argument in the method function. this prevents all.x argument from working. rename method column
	names(Res)[names(Res)=="method"]<-"Method"
	names(Het)[names(Het)=="method"]<-"Method"
	names(SingleSNPs)[names(SingleSNPs)=="method"]<-"Method"

	ResHet<-merge(Res,Het,by=c("id.outcome","Method"),all.x=T)
	ResSNP<-rbind.fill(ResHet,SingleSNPs)

	if(ao_slc)
	{
		ao<-available_outcomes()
		names(ao)[names(ao)=="nsnp" ]<-"nsnps.outcome.array"
		ResAo<-merge(ResSNP,ao[,!names(ao) %in% c("unit","priority","sd","path","note","filename","access","mr")],by.x="id.outcome",by.y="id")
	}

	ResAo$nsnp[is.na(ResAo$nsnp)]<-1

	for(i in unique(ResAo$id.outcome))
	{
		Methods<-unique(ResAo$method[ResAo$id.outcome==i])
		Methods<-Methods[Methods!="Wald ratio"]
		for(j in unique(Methods))
		{
			ResAo$snp[ResAo$id.outcome == i & ResAo$method==j]<-paste(ResAo$snp[ResAo$id.outcome == i & ResAo$method=="Wald ratio"],collapse=", ")
		}
	}

	if(Exp){
		ResAo$or<-exp(ResAo$b)
		ResAo$or_lci95<-exp(ResAo$b-ResAo$se*1.96)
		ResAo$or_uci95<-exp(ResAo$b+ResAo$se*1.96)
	}

	# add intercept test from MR Egger
	Egger_intercept<-Egger_intercept[,c("id.outcome","egger_intercept","se","pval")]
	Egger_intercept$Method<-"MR Egger"
	names(Egger_intercept)[names(Egger_intercept)=="egger_intercept"]<-"intercept"
	names(Egger_intercept)[names(Egger_intercept)=="se"]<-"intercept_se"
	names(Egger_intercept)[names(Egger_intercept)=="pval"]<-"intercept_pval"


	ResEgg<-merge(ResAo,Egger_intercept,by=c("id.outcome","Method"),all.x=T)

	# names(ResSNP)<-tolower(names(ResSNP))
	return(ResEgg)
}


